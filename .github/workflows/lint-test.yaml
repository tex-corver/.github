# .github/workflows/docker-build-push.yml
name: Build and Push Docker Image

on:
  workflow_call:
    inputs:
      org-name:
        required: false
        type: string
        default: ${{ github.repository_owner }}
        description: |
          Organization or team name that groups related applications together.
          This creates logical separation between different teams/projects in the deployment environment.
          Used as part of your application's domain name and Docker image name.
          Examples: 'tex-corver', 'jannic-ai', ...
          Default: Repository owner name
      project-name:
        required: true
        type: string
        description: |
          Unique identifier for your specific application or service within the organization.
          Used for Docker image naming, deployment identification, and application configuration.
          Should be descriptive and follow naming conventions (lowercase, hyphens allowed).
          Examples: 'user-service', 'pay4me', 'landing-page', ...
      test-command:
        required: false
        type: string
        default: make test
        description: |
          Command to run tests before building the Docker image.
          If tests fail, others steps will be aborted.
          Examples: 'npm test', 'pytest', 'go test ./...'
          Default: 'make test' (assuming you have a Makefile with a 'test' target)
      lint-command:
        required: false
        type: string
        default: make lint
        description: |
          Command to run tests before building the Docker image.
          If tests fail, others steps will be aborted.
          Examples: 'npm test', 'pytest', 'go test ./...'
          Default: 'make test' (assuming you have a Makefile with a 'test' target)
      docker-build-file:
        required: false
        type: string
        default: Dockerfile
        description: |
          Relative path from root of repository to the Dockerfile used for building your application image.
          Useful when you have multiple Dockerfiles or when the Dockerfile is in a subdirectory.
          Examples: 'Dockerfile', 'docker/Dockerfile', 'src/apps/api/Dockerfile'
          Default: 'Dockerfile' (in repository root)
      docker-build-context:
        required: false
        type: string
        default: .
        description: |
          Directory path that contains all the files needed to build your Docker image.
          This determines which files are available during the build process (COPY, ADD commands).
          Should contain all necessary source code, dependencies, and configuration files.
          Examples: '.', 'src/apps/schedule-manager', ...
          Default: '.' (repository root)

      create-pr:
        required: false
        type: boolean
        default: true
        description: |
          Whether to create a pull request to merge the changes into the `master` branch after deployment.
          Useful for development workflows where you want to review changes before merging.
          If false, the workflow will not create a PR, but the deployment will still proceed.
          Ignored if the workflow is triggered on `master` branch.
          Default: true
env:
  REGISTRY: artifactory-jcr.artifactory-jcr.svc:8081
  DOCKER_PASSWORD: y9wb3N0Z3
  DOCKER_USERNAME: admin
  IMAGE_NAME: ${{ inputs.org-name }}-${{ inputs.project-name }}
  INGRESS_HOST: ${{ inputs.ingress-domain  }}

jobs:
  lint-test:
    runs-on: arc-runner-set
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Make
        run: sudo apt-get update && sudo apt-get install -y make
      - name: Set up python
        id: setup-python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: false
      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v7

      - name: Run tests
        run: |
          echo "Running tests..."
          echo "Using test command: ${{ inputs.test-command }}"
          if ! ${{ inputs.test-command }}; then
            echo "Tests failed, aborting workflow"
            exit 1
          fi
          echo "Tests completed successfully"
      - name: Lint code
        run: |
          echo "Running linting..."
          echo "Using lint command: ${{ inputs.lint-command }}"
          if ! ${{ inputs.lint-command }}; then
            echo "Linting failed, aborting workflow"
            exit 1
          fi
          echo "Linting completed successfully"

  build-image:
    runs-on: arc-runner-set
    needs: lint-test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          buildkitd-config-inline: |
            [registry."${{ env.REGISTRY }}"]
              insecure = true
              http = true

      - name: Log in to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ env.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ${{ inputs.docker-build-context }}
          file: ${{ inputs.docker-build-file }}
          platforms: linux/amd64
          push: false
          tags: ${{ env.REGISTRY }}/docker/${{ env.IMAGE_NAME }}:dev
          ssh: default=/home/runner/.ssh/id_ed25519
          cache-from: type=registry,ref=${{ env.REGISTRY }}/cache/cache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/cache/cache,mode=max
